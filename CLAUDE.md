# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

STM32F407VG embedded systems project with FreeRTOS 202406.04-LTS running on ARM Cortex-M4F. Target hardware is the STM32F4 Discovery Board (168 MHz, 192 KB RAM, 1 MB Flash).

## Build Commands

**Prerequisites:** ARM GNU toolchain (`arm-none-eabi-gcc`, `arm-none-eabi-g++`, `arm-none-eabi-objcopy`, `arm-none-eabi-size`), CMake 3.22+, Ninja.

```bash
# Debug build
cd 001_HelloWorld
cmake --preset Debug
cmake --build --preset Debug

# Release build
cmake --preset Release
cmake --build --preset Release
```

Build artifacts are in `001_HelloWorld/build/{Debug,Release}/`:
- `001_HelloWorld.elf` - main executable
- `001_HelloWorld.map` - linker map with memory usage
- `compile_commands.json` - for IDE/clangd indexing

**Generate binary/hex for flashing:**
```bash
arm-none-eabi-objcopy -O binary build/Debug/001_HelloWorld.elf firmware.bin
arm-none-eabi-objcopy -O ihex build/Debug/001_HelloWorld.elf firmware.hex
```

## Architecture

```
001_HelloWorld/
├── Core/
│   ├── Inc/          # Application headers (FreeRTOSConfig.h, main.h)
│   └── Src/          # Application code (main.c, interrupt handlers)
├── Drivers/
│   ├── STM32F4xx_HAL_Driver/  # STM32 HAL/LL drivers
│   └── CMSIS/                  # ARM Cortex-M headers
├── Middlewares/ST/STM32_USB_Host_Library/  # USB host stack
├── USB_HOST/                   # USB host application layer
├── cmake/                      # Toolchain and STM32CubeMX CMake files
├── startup_stm32f407xx.s       # ARM assembly startup
└── STM32F407XX_FLASH.ld        # Linker script (1024K Flash, 192K RAM)

ThirdParty/FreeRTOS/
├── include/          # FreeRTOS public API
├── portable/
│   ├── GCC/ARM_CM4F/ # Cortex-M4F port
│   └── MemMang/      # heap_4.c used (75 KB heap)
└── *.c               # Kernel implementation (tasks, queues, timers)
```

## FreeRTOS Configuration

Key settings in `Core/Inc/FreeRTOSConfig.h`:
- Preemptive scheduling, 5 priority levels
- Tick rate: 1000 Hz
- Heap: 75 KB using heap_4 allocator
- Mutexes, semaphores, software timers enabled
- Stack overflow checking enabled (method 2)

## STM32CubeMX Integration

Files generated by STM32CubeMX contain `USER CODE BEGIN/END` markers. Place custom code only within these sections to preserve changes across regeneration. The `.ioc` file is the STM32CubeMX project.

## Hardware Configuration

**Configured peripherals (in main.c):**
- I2C1: 100 kHz (sensors)
- I2S3: 96 kHz Philips standard (audio codec)
- SPI1: Master mode, 8-bit
- GPIO: LEDs (LD3-LD6 on Port D), USB, audio codec, buttons, MEMS

## Compiler Settings

- C11 with GNU extensions
- Debug: `-O0 -g3`, Release: `-Os -g0`
- Strict warnings: `-Wall -Wextra -Wpedantic -Werror -Wconversion`
- Target flags: `-mcpu=cortex-m4 -mfpu=fpv4-sp-d16 -mfloat-abi=hard`
